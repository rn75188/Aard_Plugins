<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="ChaosPortal_Counter"
   author="Tipro"
   id="436f1c1d0dc0ceb89f323429"
   language="Lua"
   purpose="Count the number of times each chaos portal is used"
   date_written="2024-04-26 20:07:01"
   requires="5.07"
   version="1.0"
   >

</plugin>

<aliases>

<alias
   enabled="y"
   ignore_case="y"
   match="^chaos_portal bag (\d+)"
   name="chaos_portal_bag"
   omit_from_output="n"
   regexp="y"
   script="chaos_portal_bag"
   sequence="100"
   send_to="12"
>
</alias>
</aliases>

<triggers>

<trigger
   enabled="y"
   match="WHOOOOOOOOOOOOSH!"
   name="portal_entered"
   script="portal_entered"
   send_to="14"
>
<send>
    EnableTrigger("eqdata_start", true)
</send>
</trigger>

<trigger
  enabled="y"
  name="eqdata_start"
  match="{invdata (\d+)}"
  omit_from_output="y"
  regexp="y"
  send_to="14"  
>
<send>
    EnableTrigger("eqdata_capture_first", true)
</send>
</trigger>

<trigger
   enabled="y"
   name="eqdata_capture_first"
   match="^(\d+),*"
   omit_from_output="y"
   regexp="y"
   send_to="14"
   script="eqdata_capture"
>
<send>
    EnableTrigger("eqdata_capture_first", false)
    EnableTrigger("eqdata_ignore_remainder", true)
    EnableTrigger("eqdata_end", true)
</send>
</trigger>

<trigger
   enabled="n"
   name="eqdata_ignore_remainder"
   match="^(\d+),*"
   omit_from_output="y"
   regexp="y"
>
</trigger>

<trigger
   enabled="n"
   name="eqdata_end"
   match="{/invdata}"
   omit_from_output="y"
   regexp="y"
  send_to="14"
>
<send>
    EnableTrigger("eqdata_start", false)
    EnableTrigger("eqdata_capture_first", false)
    EnableTrigger("eqdata_ignore_remainder", false)
    EnableTrigger("eqdata_end", false)
</send>
</trigger>

</triggers>

<script>

bagid = 0

function OnPluginInstall()
  print("ChaosPortal_Counter installed")
  print("DONT FORGET - Track the bag that holds chaos portals with 'chaos_portal bag [objid]'")
end

function chaos_portal_bag(name, line, wildcards)
  local objid = tonumber(wildcards[1])
  bagid = objid
  print("Chaos portal bag set to " .. bagid)
end


function portal_entered()  
  if bagid == 0 then
    print("No bag set for chaos portals")
    return
  end

  SendNoEcho("invdata " .. bagid)
end

function eqdata_capture(name,line,wildcards)
  local portal = tonumber(wildcards[1])
  print("Portal " .. portal .. " entered")
end

</script>


</muclient>
